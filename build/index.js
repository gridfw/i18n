var Glob,I18N,I18N_LANG_FORMAT,Path,_clear,_loadI18nMap,_loadLocal,_reqWrapper,_setLocal,fs;Glob=require("glob"),Path=require("path"),fs=require("mz/fs"),I18N_LANG_FORMAT=/^(?:[a-z]{2}|[a-z]{2}-[A-Z]{2})\.js$/,_clear=function(e){e.m=null,e.c=Object.create(null)},_loadI18nMap=function(e){return new Promise(function(t,n){var a;return a=Object.create(null),Glob(e,{nodir:!0},function(e,r){var i,o,l,s;try{if(e)throw e;if(!r.length)throw"No i18n file found";for(l=0,s=r.length;l<s;l++){if(i=r[l],o=Path.basename(i),!I18N_LANG_FORMAT.test(o))throw new SyntaxError(`Illegal file name: [${o}], should matches: ${I18N_LANG_FORMAT}`);if((o=o.slice(0,-3))in a)throw new Error(`Multiple files found for local: ${filename}`);a[o]=i}t(a)}catch(t){n(e=t)}})})},_reqWrapper=function(e){var t,n;return n=e.s,t=async function(t){return await e.get(t)||t.length>2&&await e.get(local.substr(0,2))},async function(e,a){var r,i,o,l;if(o=e.query[n[2]])return await t(o)&&n[5](e,o),(l=new URL(e.url)).searchParams.delete(n[2]),e.redirect(l);try{null==(o=(r=n[3])?await r(e):await n[4](e))&&(o=n[0])}catch(e){e,o=n[0]}return null==(i=await t(o||n[0]))&&(i=await t(n[0])),Object.defineProperty(e,"i18n",{value:i,configurable:!0}),Object.defineProperty(e.locals,"i18n",{value:i,configurable:!0}),a()}},_setLocal=async function(e,t){var n,a;if(n=this.app.i18n,!(a=await n.get(e))&&(t&&e.length>2&&(a=await n.get(e.substr(0,2))),!a))throw new Error(`Unknown local: ${e}`);Object.defineProperty(this,"i18n",{value:a,configurable:!0}),Object.defineProperty(this.locals,"i18n",{value:a,configurable:!0})},_loadLocal=async function(local){var i18n;return i18n=this.c[local],i18n||(i18n=this.m[local],i18n?(i18n=eval(await fs.readFile(i18n)),this.c[local]=i18n,i18n):i18n)},I18N=class{constructor(e){this.app=e,this.enabled=!0,this.m=null,this.c=Object.create(null),this.s=[],this._wrapper=_reqWrapper(this),this.get=_loadLocal,Object.defineProperty(this.app,"i18n",{value:this,configurable:!0})}async reload(e){var t,n,a,r,i,o,l,s,c,f;for(n=0,a=(i=["default","param","setLangParam"]).length;n<a;n++)if((r=i[n])in e&&"string"!=typeof e[r])throw new Error(`options.${r} expected string`);if("ctxLocal"in e&&"function"!=typeof e.ctxLocal)throw new Error("options.ctxLocal expected function");if("cache"in e&&"boolean"!=typeof e.cache)throw new Error("options.cache expected boolean");if(_clear(this),!((t=e.default||"en")in(this.m=await _loadI18nMap(e.locals||Path.join(process.cwd,"i18n")))))throw new Error(`Default local [${t}] is missing`);if("object"==typeof(o=e.session)){if("function"!=typeof o.set)throw new Error("session.set function is required");if("function"!=typeof o.get)throw new Error("session.get function is required");l=o.get,c=o.set}else{if("string"!=typeof o&&o)throw new Error("Illegal options.session");s=o||"i18n",l=function(e){return e.session.get(s)},c=function(e,t){return e.session.set(s,t)}}(f=this.s)[0]=t,f[1]=e.param||"i18n",f[2]=e.setLangParam||"set-lang",f[3]=e.ctxLocal,f[4]=l,f[5]=c,Object.defineProperty(this.app.Context,"setLocal",{value:_setLocal,configurable:!0}),this.enable()}destroy(){this.disable(),_clear(this),delete this.app.Context.setLocal,delete this.app.i18n}disable(){this.app.unwrap(this._wrapper)}enable(){this.app.wrap(0,this._wrapper)}has(e){return e in this.m}},module.exports=I18N;